var mescroll,page=1,size=12,count=58,dis=3e3,zstData=[],isFlag=!0,saveSiteList=[],tmpList=[],type=2,distanceList=[{value:"first",text:"3000米"},{value:"second",text:"2000米"},{value:"third",text:"1000米"}],sectionList=[{value:"first",text:"全部站点"},{value:"second",text:"东区"},{value:"third",text:"西区"},{value:"fourth",text:"南区"},{value:"fifth",text:"石岐山"},{value:"six",text:"火炬区"},{value:"secen",text:"古镇"},{value:"eight",text:"三乡镇"},{value:"nine",text:"港口镇"},{value:"ten",text:"南头镇"},{value:"eleven",text:"坦洲镇"}];function initScroll(){mescroll=new MeScroll("mescroll",{down:{use:!1},up:{htmlNodata:'<p class="upwarp-nodata">-- 暂无更新数据 --</p>',offset:50,isBounce:!1,auto:!1,isBoth:!1,callback:initScrollData}})}function initScrollData(){2===type?showSection():1===type?filterNeighborhood():showSave()}function change2Section(){var t=new mui.PopPicker;t.setData(sectionList);var e=document.getElementById("showUserPicker");document.getElementById("userResult");e.addEventListener("tap",function(e){t.show(function(e){t.innerText=JSON.stringify(e[0]),$("#district").html(e[0].text),mescroll.clearDataList(),freshParam(),window.flag=e[0].text.replace("全部站点",""),showSection()})},!1)}function freshParam(){page=1,isFlag=!0,$(".content-list").empty(),mescroll.destroy(),initScroll()}function listenTab(){$(".tab-item").each(function(t){$(this).off("touchstart").on("touchstart",function(){switch($(".tab-active").removeClass("tab-active"),$(this).addClass("tab-active"),freshParam(),t){case 0:type=0,initScrollData();break;case 1:type=1,initScrollData();break;case 2:type=2,initScrollData()}})})}function showSection(){$("#distance-box").hide(),$("#district-box").show();var t="",e=zstData;if(saveSiteList=localStorage.saveSiteList?JSON.parse(localStorage.saveSiteList):[],window.flag&&(e=_.filter(e,function(t){return _.includes(t.address,flag)})),tmpList=e,console.log(page,e.length),e.length)if(count=Math.ceil(e.length/size),page<=count){for(var i=e.length,s="../../img/collection@3x.png",a="",l=(page-1)*size;l<_.min([page*size,i]);l++)a=""===e[l].name?"none":"",s=_.includes(saveSiteList.idList,+e[l].id)?"../../img/alreadycollected@3x.png":"../../img/collection@3x.png",t+='<div onclick="toCommonMap('+e[l].lng+", "+e[l].lat+')" class="site-item" style="display:'+a+'"  data="'+e[l].name+'"><div class="site-head flex flex-column"><div class="site-name">'+e[l].name+'</div><div class="flex" style="width:100%;"><p class="site-availBike">类型:'+e[l].site_type+'</p><p class="site-capacity">'+e[l].phone+'</p></div><div class="site-footer flex"><p><img src="../../img/location@3x.png">'+e[l].address+'</p><div onclick="saveSite('+e[l].id+","+l+', event);" class="collect-pic"><img id="pic'+e[l].id+'" class="collect" src="'+s+'"></div></div></div></div>';$("#mescroll .content-list").append(t),page++,mescroll.endSuccess()}else mescroll.endUpScroll(!0);else mescroll.endUpScroll(!0)}function change2Neighborhood(){var t=new mui.PopPicker;t.setData(distanceList);var e=document.getElementById("showDistancePicker");document.getElementById("distanceResult");e.addEventListener("tap",function(e){t.show(function(e){t.innerText=JSON.stringify(e[0]),$("#distance").html(e[0].text),dis=+e[0].text.replace("米",""),freshParam(),filterNeighborhood()})},!1)}function filterNeighborhood(){var t=localStorage.location?JSON.parse(localStorage.location):{},e=zstData;showNeighborhood(_.filter(e,function(e){return _.gte(dis||3e3,distanceCaculate({lat0:t.lat,lng0:t.lng,lat:e.lat,lng:e.lng}))}))}function showNeighborhood(t){$("#distance-box").show(),$("#district-box").hide();var e="";if(tmpList=t,saveSiteList=localStorage.saveSiteList?JSON.parse(localStorage.saveSiteList):[],console.log(page,t.length,dis),t.length)if(count=Math.ceil(t.length/size),page<=count){for(var i=t.length,s="",a=(page-1)*size;a<_.min([page*size,i]);a++)s=""===t[a].name?"none":"",_.includes(saveSiteList.idList,t[a].id)?pic="../../img/alreadycollected@3x.png":pic="../../img/collection@3x.png",e+='<div onclick="toCommonMap('+t[a].lng+", "+t[a].lat+')" class="site-item" style="display:'+s+'"  data="'+t[a].name+'"><div class="site-head flex flex-column"><div class="site-name">'+t[a].name+'</div><div class="flex" style="width:100%;"><p class="site-availBike">类型:'+t[a].site_type+'</p><p class="site-capacity">'+t[a].phone+'</p></div><div class="site-footer flex"><p><img src="../../img/location@3x.png">'+t[a].address+'</p><div onclick="saveSite('+t[a].id+","+a+', event);" class="collect-pic"><img id="pic'+t[a].id+'" class="collect" src="'+pic+'"></div></div></div></div>';$(".content-list").append(e),page++,mescroll.endSuccess()}else mescroll.showNoMore();else mescroll.showNoMore()}function toCommonMap(t,e){toMap({longitude:t.toString(),latitude:e.toString(),markType:"zswd",marks:zstData})}function showSave(){$("#distance-box").hide(),$("#district-box").hide();var t="",e=saveSiteList.list||[];console.log(e);var i=e.length,s="";if(i&&isFlag){for(var a=0;a<i;a++)s=""===e[a].name?"none":"",t+='<div id="delete'+e[a].id+'"  onclick="toCommonMap('+e[a].lng+", "+e[a].lat+')" class="site-item" style="display:'+s+'"  data="'+e[a].name+'"><div class="site-head flex flex-column"><div class="site-name">'+e[a].name+'</div><div class="flex" style="width:100%;"><p class="site-availBike">类型:'+e[a].site_type+'</p><p class="site-capacity">'+e[a].phone+'</p></div><div class="site-footer flex"><p><img src="../../img/location@3x.png">'+e[a].address+'</p><div onclick="deleteSite('+e[a].id+',event);" class="collect-pic"><img id="pic'+e[a].id+'" class="collect" src="../../img/alreadycollected@3x.png"></div></div></div></div>';isFlag=!1,$(".content-list").append(t)}mescroll.showNoMore()}function listenSearch(){$(".search-btn").off("touchstart").on("touchstart",function(){var t=$(".search-input").val();console.log(t),t.length?location.href="./search.html?query="+t:zct.alert({content:"请输入搜索内容"})}),$(".search-input").off("keydown").on("keydown",function(t){var e=$(this).val();13===t.keyCode&&(e.length?location.href="./search.html?query="+e:zct.alert({content:"请输入搜索内容"}))})}function deleteSite(t,e){(saveSiteList=localStorage.saveSiteList?JSON.parse(localStorage.saveSiteList):{idList:[],list:[]}).idList=_.filter(saveSiteList.idList,function(e){return+e!==t}),saveSiteList.list=_.filter(saveSiteList.list,function(e){return+e.id!==t}),console.log(saveSiteList),localStorage.saveSiteList=JSON.stringify(saveSiteList),$("#delete"+t).remove(),e.stopPropagation()}function saveSite(t,e,i){console.log(t,e,i),saveSiteList=localStorage.saveSiteList?JSON.parse(localStorage.saveSiteList):{idList:[],list:[]},_.includes(saveSiteList.idList,t)||(saveSiteList.idList.push(t),saveSiteList.list.push(tmpList[e]),localStorage.saveSiteList=JSON.stringify(saveSiteList),$("#pic"+t).attr("src","../../img/alreadycollected@3x.png")),i.stopPropagation()}$(function(){zct.showLoading(),setTimeout(function(){zct.hideLoading()},500),ajax({host:CONFIG.site+"ZST/zstData/zstLocation.json",url:""},function(t){_.forEach(t,function(t,e){zstData.push(t)}),zstData=_.flatten(zstData),zstData=_.uniqBy(zstData,"id"),localStorage.siteList=JSON.stringify(zstData),console.log(zstData),initScroll(),initScrollData()}),zct.getLocation(function(t){$("#menu-map").click(function(){toMap({longitude:t.longitude.toString(),latitude:t.latitude.toString(),markType:"zswd",marks:zstData})})}),listenTab(),listenSearch()}),mui.ready(function(){change2Section(),change2Neighborhood()});