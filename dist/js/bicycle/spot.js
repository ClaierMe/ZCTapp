var mescroll,page=1,size=12,count=58,dis=3e3,isFlag=!0,savePosList=[],type=2,distanceList=[{value:"first",text:"3000米"},{value:"second",text:"2000米"},{value:"third",text:"1000米"}],sectionList=[{value:"first",text:"全部站点"},{value:"second",text:"东区"},{value:"third",text:"西区"},{value:"fourth",text:"南区"},{value:"fifth",text:"石岐山"},{value:"six",text:"火炬区"},{value:"secen",text:"古镇"},{value:"eight",text:"三乡镇"},{value:"nine",text:"港口镇"},{value:"ten",text:"南头镇"},{value:"eleven",text:"坦洲镇"}];function initScroll(){mescroll=new MeScroll("mescroll",{down:{use:!1},up:{htmlNodata:'<p class="upwarp-nodata">-- 暂无更新数据 --</p>',offset:50,isBounce:!1,auto:!1,isBoth:!1,callback:initScrollData}})}function initScrollData(){2===type?showSection():1===type?filterNeighborhood():showSave()}function change2Section(){var e=new mui.PopPicker;e.setData(sectionList);var t=document.getElementById("showUserPicker");document.getElementById("userResult");t.addEventListener("tap",function(t){e.show(function(t){e.innerText=JSON.stringify(t[0]),$("#district").html(t[0].text),mescroll.clearDataList(),freshParam(),window.flag=t[0].text.replace("全部站点",""),showSection()})},!1)}function freshParam(){page=1,isFlag=!0,$(".content-list").empty(),mescroll.destroy(),initScroll()}function listenTab(){$(".tab-item").each(function(e){$(this).off("touchstart").on("touchstart",function(){switch($(".tab-active").removeClass("tab-active"),$(this).addClass("tab-active"),freshParam(),e){case 0:type=0,initScrollData();break;case 1:type=1,initScrollData();break;case 2:type=2,initScrollData()}})})}function showSection(){$("#distance-box").hide(),$("#district-box").show();var e="",t=JSON.parse(localStorage.bike);if(savePosList=localStorage.savePosList?JSON.parse(localStorage.savePosList):[],window.flag&&(t=_.filter(t,function(e){return _.includes(e.address,flag)})),console.log(page,t.length),t.length)if(count=Math.ceil(t.length/size),page<=count){for(var s=t.length,a="../../img/collection@3x.png",i="",o=(page-1)*size;o<_.min([page*size,s]);o++)i=""===t[o].name?"none":"",a=_.includes(savePosList.idList,t[o].id)?"../../img/alreadycollected@3x.png":"../../img/collection@3x.png",e+='<div onclick="toCommonMap('+t[o].lng+", "+t[o].lat+')" class="pos-item" style="display:'+i+'"  data="'+t[o].name+'"><div class="pos-head flex"><p class="pos-name">'+t[o].name+'</p><p class="pos-availBike">可借:<span class="red">'+t[o].availBike+'</span></p><p class="pos-capacity">可停:<span class="red">'+t[o].capacity+'</span></p></div><div class="pos-footer flex"><p><img src="../../img/location@3x.png">'+t[o].address+'</p><div onclick="savePos('+t[o].id+', event);" class="collect-pic"><img id="pic'+t[o].id+'" class="collect" src="'+a+'"></div></div></div>';$("#mescroll .content-list").append(e),page++,mescroll.endSuccess()}else mescroll.endUpScroll(!0);else mescroll.endUpScroll(!0)}function change2Neighborhood(){var e=new mui.PopPicker;e.setData(distanceList);var t=document.getElementById("showDistancePicker");document.getElementById("distanceResult");t.addEventListener("tap",function(t){e.show(function(t){e.innerText=JSON.stringify(t[0]),$("#distance").html(t[0].text),dis=+t[0].text.replace("米",""),freshParam(),filterNeighborhood()})},!1)}function filterNeighborhood(){var e=localStorage.location?JSON.parse(localStorage.location):{},t=JSON.parse(localStorage.bike);showNeighborhood(_.filter(t,function(t){return _.gte(dis||3e3,distanceCaculate({lat0:e.lat,lng0:e.lng,lat:t.lat,lng:t.lng}))}))}function showNeighborhood(e){$("#distance-box").show(),$("#district-box").hide();var t="";if(savePosList=localStorage.savePosList?JSON.parse(localStorage.savePosList):[],console.log(page,e.length,dis),e.length)if(count=Math.ceil(e.length/size),page<=count){for(var s=e.length,a="",i=(page-1)*size;i<_.min([page*size,s]);i++)a=""===e[i].name?"none":"",_.includes(savePosList.idList,e[i].id)?pic="../../img/alreadycollected@3x.png":pic="../../img/collection@3x.png",t+='<div onclick="toCommonMap('+e[i].lng+", "+e[i].lat+')" class="pos-item" style="display:'+a+'"  data="'+e[i].name+'"><div class="pos-head flex"><p class="pos-name">'+e[i].name+'</p><p class="pos-availBike">可借:<span class="red">'+e[i].availBike+'</span></p><p class="pos-capacity">可停:<span class="red">'+e[i].capacity+'</span></p></div><div class="pos-footer flex"><p><img src="../../img/location@3x.png">'+e[i].address+'</p><div onclick="savePos('+e[i].id+', event);" class="collect-pic"><img id="pic'+e[i].id+'" class="collect" src="'+pic+'"></div></div></div>';$(".content-list").append(t),page++,mescroll.endSuccess()}else mescroll.showNoMore();else mescroll.showNoMore()}function toCommonMap(e,t){toMap({longitude:e.toString(),latitude:t.toString(),markType:"zsbike",marks:JSON.parse(localStorage.bike)})}function showSave(){$("#distance-box").hide(),$("#district-box").hide();var e="",t=JSON.parse(localStorage.savePosList).list||[];console.log(t);var s=t.length,a="";if(s&&isFlag){for(var i=0;i<s;i++)a=""===t[i].name?"none":"",e+='<div id="delete'+t[i].id+'" onclick="toCommonMap('+t[i].lng+", "+t[i].lat+')" class="pos-item" style="display:'+a+'"  data="'+t[i].name+'"><div class="pos-head flex"><p class="pos-name">'+t[i].name+'</p><p class="pos-availBike">可借:<span class="red">'+t[i].availBike+'</span></p><p class="pos-capacity">可停:<span class="red">'+t[i].capacity+'</span></p></div><div class="pos-footer flex"><p><img src="../../img/location@3x.png">'+t[i].address+'</p><img onclick="deleteSave('+t[i].id+', event)" class="collect" src="../../img/alreadycollected@3x.png"></div></div>';isFlag=!1,$(".content-list").append(e)}mescroll.showNoMore()}function listenSearch(){$(".search-btn").off("touchstart").on("touchstart",function(){var e=$(".search-input").val();console.log(e),e.length?location.href="./search.html?query="+e:zct.alert({content:"请输入搜索内容"})}),$(".search-input").off("keydown").on("keydown",function(e){var t=$(this).val();13===e.keyCode&&(t.length?location.href="./search.html?query="+t:zct.alert({content:"请输入搜索内容"}))})}function deleteSave(e,t){(savePosList=localStorage.savePosList?JSON.parse(localStorage.savePosList):{idList:[],list:[]}).idList=_.filter(savePosList.idList,function(t){return+t!==e}),savePosList.list=_.filter(savePosList.list,function(t){return+t.id!==e}),console.log(savePosList),localStorage.savePosList=JSON.stringify(savePosList),$("#delete"+e).remove(),t.stopPropagation()}function savePos(e,t){console.log(e,t),savePosList=localStorage.savePosList?JSON.parse(localStorage.savePosList):{idList:[],list:[]},_.includes(savePosList.idList,e)||(savePosList.idList.push(e),savePosList.list.push(JSON.parse(localStorage.bike)[e-1]),localStorage.savePosList=JSON.stringify(savePosList),$("#pic"+e).attr("src","../../img/alreadycollected@3x.png")),t.stopPropagation()}$(function(){zct.showLoading(),zct.getLocation(function(e){$("#menu-map").click(function(){toMap({longitude:e.longitude.toString(),latitude:e.latitude.toString(),markType:"zsbike",marks:JSON.parse(localStorage.bike)})})}),listenTab(),listenSearch(),initScroll(),initScrollData(),zct.setTitleBarRightButton({title:"报障"},function(){location.href="../../views/bikeMalfunction.html"}),setTimeout(function(){zct.hideLoading()},500)}),mui.ready(function(){change2Section(),change2Neighborhood()});